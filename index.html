<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<title>Who's Driving?</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<!-- Styles -->
		<style type="text/css">
			body {
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
				font-size: 112.5%;
				max-width: 40em;
				width: 88%;
				margin-left: auto;
				margin-right: auto;
			}

			/**
			 * Form styles
			 */

			label,
			input {
				display: block;
				width: 100%;
			}
		</style>
	</head>

	<body>

		<h1>Who's Driving?</h1>

		<div id="app" aria-live="polite"></div>

		<form id="add-driver">
			<label for="driver-name">Add a name to the list of possible drivers</label>
			<input type="text" id="driver-name">
			<button>Add a Driver</button>
		</form>

		<p>
			<button id="pick-driver">Pick a Driver</button>
			<button id="clear-drivers">Remove All Drivers</button>
		</p>

		<script src="component.js"></script>
		<script>

			//== Helpers ==//

			/*!
			 * Sanitize and encode all HTML in a user-submitted string
			 * (c) 2018 Chris Ferdinandi, MIT License, https://gomakethings.com
			 * @param  {String} str  The user-submitted string
			 * @return {String} str  The sanitized string
			 */
			var sanitizeHTML = function (str) {
				var temp = document.createElement('div');
				temp.textContent = str;
				return temp.innerHTML;
			};

			/**
			 * Randomly shuffle an array
			 * https://stackoverflow.com/a/2450976/1293256
			 * @param  {Array} array The array to shuffle
			 * @return {String}      The first item in the shuffled array
			 */
			var shuffle = function (array) {

				var currentIndex = array.length;
				var temporaryValue, randomIndex;

				// While there remain elements to shuffle...
				while (0 !== currentIndex) {
					// Pick a remaining element...
					randomIndex = Math.floor(Math.random() * currentIndex);
					currentIndex -= 1;

					// And swap it with the current element.
					temporaryValue = array[currentIndex];
					array[currentIndex] = array[randomIndex];
					array[randomIndex] = temporaryValue;
				}

				return array;

			};

			//== Methods ==//

			// Create app component
			var app = new Component('#app', {
				data: {
					drivers: [],
					selected: null
				},
				template: function(props) {
					// Save drivers to local storage
					localStorage.setItem('drivers', JSON.stringify(props.drivers));

					// Make sure there's at least 1 driver
					if (props.drivers.length < 1) return '<p><em>To get started, add a couple of drivers using the form below.</em></p>';

					// Create selected driver markup
					var selected = '';
					if (props.selected) {
						selected = '<p><strong>' + sanitizeHTML(props.selected) + ' is the driver.</strong></p>';
					}

					// Display list of drivers
					return '<ul>' + props.drivers.map(function(driver, index) {
						var name = sanitizeHTML(driver);
						return '<li>' + name + ' <button data-driver="' + index + '" aria-label="Remove ' + name + '">Remove</button></li>';
					}).join('') + '</ul>' + selected;
				}
      });

			// Pick the driver
			var pickDriver = function(event) {
				// Get a copy of the drivers
				var data = app.getData();

				// Make sure there are at least 2 possible drivers
				if (data.drivers.length < 2) {
					alert('Ooops! You need at least 2 drivers. Please add more drivers.');
					return;
				}

				// Shuffle list of drivers
				shuffle(data.drivers);

				// Pick the driver
				var selected = data.drivers[0];
				if (data.selected && selected === data.selected) {
					selected = data.drivers[1];
				}

				// Update the data and UI
				app.setData({selected: selected});
			};

			// Remove single driver
			var removeDriver = function(driver) {
				// Get a copy of the drivers
				var data = app.getData();

				// Remove the driver from the list
				data.drivers.splice(driver, 1);

				// Update the data and UI
				app.setData({drivers: data.drivers});
			};

			// Clear all drivers
			var clearDrivers = function(event) {
				// Confirm with user before removing all drivers from list
				if (!confirm('Are you sure you want to remove all drivers?')) return;

				// Reset all driver data
				app.setData({
					drivers: [],
					selected: null
				});
			};

			// Handle click events
			var clickHandler = function(event) {
				// If click is on #pick-driver button
				if (event.target.id === 'pick-driver') {
					pickDriver();
				}

				// If click is on [data-driver] button
				var driver = event.target.getAttribute('data-driver');
				if (driver) {
					removeDriver(driver);
				}

				// If click is on #clear-drivers button
				if (event.target.id === 'clear-drivers') {
					clearDrivers();
				}
			};

			// Handle submit events
			var submitHandler = function(event) {
				// Make sure submitted form is #add-driver form
				if (event.target.id !== 'add-driver') return;

				// Prevent form from submitting to server
				event.preventDefault();

				// Get the driver name
				var input = document.querySelector('#driver-name');
				if (!input || input.value < 1) return;

				// Update the data and UI
				var data = app.getData();
				data.drivers.push(input.value);
				app.setData({drivers: data.drivers});

				// Clear input field and return focus
				input.value = '';
				input.focus();
			};

			//== Inits & Event Listeners ==//

			// Render the initial app UI
			var saved = localStorage.getItem('drivers');
			// Check for existing drivers first
			if (saved) {
				app.setData({drivers: JSON.parse(saved)});
			} else {
				app.render();
			}

			// Listen for events
			document.addEventListener('submit', submitHandler, false);
			document.addEventListener('click', clickHandler, false);

		</script>
	</body>
</html>
